#!/bin/sh
cd ${0%/*} || exit 1    # Run from this directory

gnuplot<<'EOF'
    # Read all parameters from overview file
    system("awk 'NF >= 2 {print $1 \" = \" $2}' overview > .params.tmp")
    load '.params.tmp'
    system("rm -f .params.tmp")
    
    # Print all loaded parameters
    system("awk 'NF >= 2 {printf \"%s = %s\\n\", $1, $2}' overview")

    set datafile separator " "
    set datafile commentschars "#"
    set grid

    # --------------------------------------------------
    # Check if experimental file exists
    data_exists = system("test -f data.csv && echo 1 || echo 0")
    col_count = 0

    if (data_exists eq "1") {
        # Detect number of columns (max fields in file)
        stats "data.csv" using 0 nooutput
        col_count = STATS_columns
    }

    # --------------------------------------------------
    # CO2 plot
    set terminal pngcairo size 800,600 enhanced font 'Verdana,10'
    set output 'CO2.png'
    set xlabel "Non-dimensional axial position, {/Symbol z}"
    set ylabel "Non-dimensional radial-averaged concentration, {/Symbol f}_{CO2}"

    if (data_exists eq "1" && col_count >= 4) {
        plot \
        "layerAveragedData" u ((D_CO2*$1)/(Uavg*R*R)):($3/(C_CO2_g*H_cc)) \
            w l lw 2 lc rgb "black" title "Simulation", \
        "data.csv" u 1:2 \
            w p pt 7 ps 1.2 lc rgb "black" title "Reference data"
    } else {
        plot \
        "layerAveragedData" u ((D_CO2*$1)/(Uavg*R*R)):($3/(C_CO2_g*H_cc)) \
            w l lw 2 lc rgb "black" title "Simulation"
    }

    # --------------------------------------------------
    # S plot
    set terminal pngcairo size 800,600 enhanced font 'Verdana,10'
    set output 'S.png'
    set xlabel "Non-dimensional axial position, {/Symbol z}"
    set ylabel "Non-dimensional radial-averaged concentration, {/Symbol f}_{S}"

    if (data_exists eq "1" && col_count >= 2) {
        plot \
        "layerAveragedData" u ((D_CO2*$1)/(Uavg*R*R)):($2/C_S0) \
            w l lw 2 lc rgb "black" title "Simulation", \
        "data.csv" u 3:4 \
            w p pt 7 ps 1.2 lc rgb "black" title "Reference data"
    } else {
        plot \
        "layerAveragedData" u ((D_CO2*$1)/(Uavg*R*R)):($2/C_S0) \
            w l lw 2 lc rgb "black" title "Simulation"
    }

EOF